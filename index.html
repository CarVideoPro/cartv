<!DOCTYPE html>
<html lang="tr">
<head>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Video Pro TV</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <script src="https://www.youtube.com/iframe_api"></script>
  
  <style>
    /* CSS KODUNUZ BURADA (Değişiklik yok) */
    :root {
        --player-height: 55px;
        --category-bar-height: 40px;
    }

    /* TEMA RENK DEĞİŞKENLERİ */
    [data-theme='default'] {
        --bg-primary: #000;
        --bg-secondary: #121212;
        --bg-tertiary: #1e1e1e;
        --bg-hover: #2c2c2c;
        --border-color: #333;
        --accent-color: #3366cc;
        --accent-color-darker: #252a3a;
        --text-primary: #fff;
        --text-secondary: #aaa;
        --epg-color: turquoise;
        --favorite-color: #ffd700; /* Altın Sarısı */
    }
    [data-theme='forest'] {
        --bg-primary: #0a0a0a;
        --bg-secondary: #1a2e24;
        --bg-tertiary: #2d4036;
        --bg-hover: #3c5246;
        --border-color: #444;
        --accent-color: #4CAF50; /* Yeşil */
        --accent-color-darker: #388E3C;
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --epg-color: #81C784;
        --favorite-color: #ffeb3b; /* Sarı */
    }
    [data-theme='royal'] {
        --bg-primary: #0d0c1d;
        --bg-secondary: #1c1a3a;
        --bg-tertiary: #2e2c5b;
        --bg-hover: #3c3a6d;
        --border-color: #4a477a;
        --accent-color: #9C27B0; /* Mor */
        --accent-color-darker: #7B1FA2;
        --text-primary: #f3e5f5;
        --text-secondary: #ce93d8;
        --epg-color: #ba68c8;
        --favorite-color: #fdd835; /* Sarı */
    }
    [data-theme='sunset'] {
        --bg-primary: #1b120f;
        --bg-secondary: #3d2c26;
        --bg-tertiary: #5d4037;
        --bg-hover: #6d4c41;
        --border-color: #4e342e;
        --accent-color: #FF5722; /* Turuncu */
        --accent-color-darker: #E64A19;
        --text-primary: #fff3e0;
        --text-secondary: #ffccbc;
        --epg-color: #ff8a65;
        --favorite-color: #ffc107; /* Kehribar */
    }
    [data-theme='steel'] {
        --bg-primary: #121212;
        --bg-secondary: #222222;
        --bg-tertiary: #333333;
        --bg-hover: #444444;
        --border-color: #555;
        --accent-color: #757575; /* Gri */
        --accent-color-darker: #616161;
        --text-primary: #f5f5f5;
        --text-secondary: #bdbdbd;
        --epg-color: #9e9e9e;
        --favorite-color: #f5f5f5; /* Beyaz */
    }


    * { box-sizing: border-box; }
    html, body {
      margin: 0; height: 100%; background: var(--bg-primary); font-family: sans-serif; overflow: hidden;
      color: var(--text-primary);
      font-size: 14px;
    }
    #app {
      display: flex; flex-direction: column; height: 100%;
      padding-bottom: calc(var(--player-height) + var(--category-bar-height));
    }
    #main {
      display: flex; flex: 1; overflow: hidden;
    }
    #channels {
      flex: 0 0 260px;
      background: var(--bg-secondary);
      border-right: 2px solid var(--border-color);
      overflow-y: auto;
      padding: 8px;
      display: flex; flex-direction: column; gap: 6px;
    }
    #previewArea {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: var(--bg-primary);
        overflow: hidden;
    }
    #previewPlaceholder {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 15px;
        color: #555;
        height: 100%;
        cursor: default;
    }
    #previewPlaceholder h2 { font-size: 1.5em; }
    #previewPlaceholder p { font-size: 1em; }

    #previewVideo {
        width: 100%; height: 100%;
        background: #000; object-fit: contain; display: none;
        cursor: pointer;
    }
    
    #youtubePlayer {
        width: 100%; height: 100%;
        background: #000;
        display: none; /* Varsayılan olarak gizli */
        cursor: pointer;
    }
    
    #groups {
        position: fixed;
        bottom: var(--player-height); left: 0; width: 100%; height: var(--category-bar-height);
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        display: flex; overflow-x: auto; z-index: 1000;
        scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--bg-secondary);
    }
    #groups::-webkit-scrollbar { height: 6px; }
    #groups::-webkit-scrollbar-track { background: var(--bg-secondary); }
    #groups::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; }

    .group {
      padding: 0 18px; cursor: pointer; background: transparent;
      border-right: 1px solid var(--border-color);
      line-height: var(--category-bar-height);
      white-space: nowrap; flex-shrink: 0;
      transition: background-color 0.2s;
    }
    .group:hover, .group.active {
      background: var(--accent-color);
    }

    .channel {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-tertiary);
      border-radius: 6px; padding: 8px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .channel-info {
        flex-grow: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .channel:hover { background: var(--bg-hover); }
    .channel.active { border-color: var(--accent-color); background: var(--accent-color-darker); }
    .channel img { width: 38px; height: 38px; object-fit: contain; flex-shrink: 0; }
    .epg-title { color: var(--epg-color); font-size: 0.9em; }

    .fav-btn {
        font-size: 22px;
        cursor: pointer;
        padding: 5px;
        color: var(--text-secondary);
        transition: color 0.2s, transform 0.2s;
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10+ */
        user-select: none;
    }
    .fav-btn:hover {
        transform: scale(1.2);
    }
    .fav-btn.favorited {
        color: var(--favorite-color);
    }

    #playerContainer {
      position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-height); background: var(--bg-secondary);
      display: flex; z-index: 999; align-items: center; padding: 0 15px;
      border-top: 2px solid var(--border-color);
      justify-content: space-between;
      gap: 20px;
    }
    .player-info { display: flex; align-items: center; gap: 12px; }
    .player-info img { width: 40px; height: 40px; object-fit: contain; border-radius: 5px; background-color: #d8d8d8; }
    .player-text .title { font-size: 1em; font-weight: bold; }
    .player-text .telegram { font-size: 0.85em; color: var(--text-secondary); }
    
    .player-controls { 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        flex-grow: 1;
        justify-content: center;
    }

    .control-btn {
      background: var(--bg-tertiary); color: var(--text-primary); 
      border: 1px solid var(--border-color);
      border-bottom: 3px solid var(--border-color);
      font-size: 14px; font-weight: bold;
      border-radius: 8px; cursor: pointer;
      height: 38px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.1s ease-in-out;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      visibility: hidden;
    }
    .control-btn:hover { 
        background: var(--bg-hover); 
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    .control-btn:active {
        transform: translateY(1px);
        border-bottom-width: 1px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    #themeSelector {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .theme-swatch {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid var(--border-color);
        transition: transform 0.2s, border-color 0.2s;
    }
    .theme-swatch:hover { transform: scale(1.1); }
    .theme-swatch.active {
        border-color: var(--text-primary);
        box-shadow: 0 0 5px var(--text-primary);
    }
  </style>
</head>
<body data-theme="default">
  <div id="app">
    <div id="main">
      <div id="channels"></div>
      <div id="previewArea">
        <div id="previewPlaceholder">
          <h1>Car Video Pro TV</h1>
          <h2>Tam Ekran için 2 kez Tıklayın</h2>
          <p>Lütfen bir kategori seçip kanala tıklayınız.</p>
        </div>
        <video id="previewVideo" autoplay playsinline></video>
        
        <div id="youtubePlayer"></div>

      </div>
    </div>
  </div>

  <div id="groups"></div>

  <div id="playerContainer">
    <div class="player-info">
      <img id="playerLogo" src="" alt="logo" style="visibility: hidden;">
      <div class="player-text">
        <div class="title">Car Video Pro</div>
        <div class="telegram">Telegram : t.me/car_video_pro</div>
      </div>
    </div>
    <div class="player-controls">
      <button class="control-btn" onclick="changeChannel(-1)">◄ Geri</button>
      <button class="control-btn" onclick="changeChannel(1)">İleri ►</button>
    </div>
    <div id="themeSelector"></div> 
  </div>

  <script>
    // ####################################################################################
    // # KANAL LİSTELERİ SİLİNDİ. VERİLER ARTIK 'channels.json' DOSYASINDAN ÇEKİLECEK.     #
    // ####################################################################################

    const epgUrl = "https://raw.githubusercontent.com/ghokun/tv/main/bin/guide.xml";
    
    const G_UI = {
        groups: document.getElementById("groups"),
        channels: document.getElementById("channels"),
        preview: {
            placeholder: document.getElementById("previewPlaceholder"),
            video: document.getElementById("previewVideo")
        },
        player: { container: document.getElementById("playerContainer"), logo: document.getElementById("playerLogo"), controls: document.querySelectorAll('.control-btn') },
        themeSelector: document.getElementById("themeSelector")
    };
    
    const themes = {
        'default': { name: 'Varsayılan', color: '#3366cc' }, 'forest': { name: 'Orman', color: '#4CAF50' }, 'royal': { name: 'Kraliyet', color: '#9C27B0' },
        'sunset': { name: 'Gün Batımı', color: '#FF5722' }, 'steel': { name: 'Çelik', color: '#757575' }
    };
    
    let allChannels = [], epgData = {}, currentChannelList = [], hls, baseChannelList = [];
    let currentChannelIndex = -1, activeGroupName = '';
    
    let ytPlayer;
    let isYouTubeApiReady = false;

    // --- YouTube API Entegrasyonu (Değişiklik yok) ---
    function onYouTubeIframeAPIReady() {
        console.log("YouTube API Hazır.");
        isYouTubeApiReady = true;
    }

    function playYouTubeStream(videoId) {
        if (!isYouTubeApiReady) {
            console.error("YouTube API henüz hazır değil.");
            return;
        }
        if (ytPlayer && typeof ytPlayer.loadVideoById === 'function' && document.getElementById('youtubePlayer')) {
             ytPlayer.loadVideoById({ videoId: videoId });
        } else {
            if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                ytPlayer.destroy();
            }
            ytPlayer = new YT.Player('youtubePlayer', { 
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1, 'autoplay': 1, 'mute': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
                events: { 'onReady': (event) => { event.target.playVideo(); } }
            });
        }
    }

    function stopYouTubeStream() {
        if (ytPlayer && typeof ytPlayer.stopVideo === 'function') {
            ytPlayer.stopVideo();
        }
        const ytElement = document.getElementById('youtubePlayer');
        if (ytElement) {
            ytElement.style.display = 'none';
        }
    }
    // --- YouTube API Entegrasyonu Bitişi ---


    // --- parseM3UText fonksiyonu SİLİNDİ (Artık Gerekli Değil) ---

    // (getFavorites, saveFavorites, toggleFavorite, applyTheme, createThemeSelector, showConnectionWarning, EPG fonksiyonları burada - Değişiklik yok)
    function getFavorites() { const favs = localStorage.getItem('iptvFavorites'); return favs ? JSON.parse(favs) : []; }
    function saveFavorites(favs) { localStorage.setItem('iptvFavorites', JSON.stringify(favs)); }
    function toggleFavorite(channelName, favButton) {
        let favorites = getFavorites();
        const index = favorites.indexOf(channelName);
        const wasEmpty = favorites.length === 0;
        if (index > -1) { favorites.splice(index, 1); favButton.classList.remove('favorited'); } 
        else { favorites.push(channelName); favButton.classList.add('favorited'); }
        saveFavorites(favorites);
        const isEmptyNow = favorites.length === 0;
        if (wasEmpty !== isEmptyNow) listGroups();
        if (activeGroupName === 'Favorilerim') listChannels('Favorilerim');
    }
    function applyTheme(themeName) {
        document.body.dataset.theme = themeName;
        localStorage.setItem('iptvTheme', themeName);
        document.querySelectorAll('.theme-swatch').forEach(swatch => swatch.classList.toggle('active', swatch.dataset.theme === themeName));
    }
    function createThemeSelector() {
        for (const [key, theme] of Object.entries(themes)) {
            const swatch = document.createElement('div');
            swatch.className = 'theme-swatch'; swatch.dataset.theme = key; swatch.title = theme.name;
            swatch.style.backgroundColor = theme.color; swatch.onclick = () => applyTheme(key);
            G_UI.themeSelector.appendChild(swatch);
        }
    }
    function showConnectionWarning(isConnected) {
        const warningId = 'connection-warning-banner'; let warningEl = document.getElementById(warningId);
        if (isConnected) { if (warningEl) warningEl.remove(); } 
        else if (!warningEl) {
            warningEl = document.createElement('div'); warningEl.id = warningId;
            warningEl.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; background-color: #f44336; color: white; text-align: center; padding: 10px 0; font-weight: bold; z-index: 10000;`;
            warningEl.textContent = 'UYARI: İnternet bağlantısı yok! Kanallar yüklenemeyebilir veya mevcut yayın durabilir.';
            document.body.prepend(warningEl);
        }
    }
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW kaydı başarısız:', err)));
    window.addEventListener('load', () => { if (!navigator.onLine) showConnectionWarning(false); });
    window.addEventListener('online', () => showConnectionWarning(true));
    window.addEventListener('offline', () => showConnectionWarning(false));
    async function fetchEPG() {
      try {
        const res = await fetch(epgUrl); if (!res.ok) throw new Error(`HTTP Hata: ${res.status}`); showConnectionWarning(true);
        const xml = await res.text(), parser = new DOMParser(), doc = parser.parseFromString(xml, "text/xml"), progs = doc.querySelectorAll("programme"), now = new Date();
        for (const p of progs) {
          const chan = p.getAttribute("channel"), start = parseEPGDate(p.getAttribute("start")), stop = parseEPGDate(p.getAttribute("stop"));
          if (now >= start && now <= stop) epgData[chan] = p.querySelector("title")?.textContent || "";
        }
      } catch (error) { console.error("EPG verisi alınamadı:", error); showConnectionWarning(false); }
    }
    function parseEPGDate(str) {
      if (!str) return new Date(0);
      const dp = str.slice(0, 14), tz = str.slice(15, 20), y = +dp.slice(0, 4), m = +dp.slice(4, 6) - 1, d = +dp.slice(6, 8), h = +dp.slice(8, 10), min = +dp.slice(10, 12);
      const s = tz[0] === '+' ? 1 : -1, th = +tz.slice(1, 3), tm = +tz.slice(3, 5), offset = s * (th * 60 + tm) * 60000;
      return new Date(new Date(Date.UTC(y, m, d, h, min)).getTime() - offset);
    }
    function listGroups() {
      const currentActiveGroup = document.querySelector('.group.active')?.textContent || 'Favorilerim';
      const desiredOrder = ['Favorilerim', 'Tüm Kanallar', 'Ulusal', 'Spor', 'Çocuk & Eğitim', 'Belgesel', 'Müzik', 'YouTube', 'Müzik Ekstra', 'Yaşam & Eğlence', 'Sinema ve Dizi', 'Ulusal Haber'];
      let groups = [...new Set(allChannels.map(c => c.group))].filter(g => g && g !== 'Bilgilendirme'); 
      groups.unshift('Favorilerim'); groups = [...new Set(groups)];
      groups.sort((a, b) => { const iA = desiredOrder.indexOf(a), iB = desiredOrder.indexOf(b); if (iA !== -1 && iB !== -1) return iA - iB; if (iA !== -1) return -1; if (iB !== -1) return 1; return a.localeCompare(b); });
      G_UI.groups.innerHTML = ""; let groupToActivate = null;
      groups.forEach((g) => {
        if (g === 'Favorilerim' && getFavorites().length === 0) return;
        const el = document.createElement("div"); el.className = "group"; el.textContent = g;
        el.onclick = () => { document.querySelectorAll(".group.active").forEach(e => e.classList.remove("active")); el.classList.add("active"); activeGroupName = g; listChannels(g); };
        G_UI.groups.appendChild(el); if (g === currentActiveGroup) groupToActivate = el;
      });
      if (groupToActivate) groupToActivate.click(); else if (G_UI.groups.firstChild) G_UI.groups.firstChild.click();
    }
    function listChannels(group) {
      G_UI.channels.innerHTML = "";
      
      const favorites = getFavorites();
      if (group === 'Favorilerim') currentChannelList = baseChannelList.filter(c => favorites.includes(c.name));
      else currentChannelList = allChannels.filter(c => c.group === group);
      
      currentChannelList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      
      currentChannelList.forEach((c, idx) => {
        const epgTitle = epgData[c.epgId] || "", isFavorited = favorites.includes(c.name);
        const el = document.createElement("div"); el.className = "channel";
        el.innerHTML = `<div class="channel-info"><img src="${c.logo || ''}" onerror="this.style.display='none'" alt="logo"><div><div>${c.name}</div><div class="epg-title">${epgTitle}</div></div></div><span class="fav-btn ${isFavorited ? 'favorited' : ''}">★</span>`;
        const channelInfo = el.querySelector('.channel-info'), favButton = el.querySelector('.fav-btn');
        channelInfo.onclick = () => { document.querySelectorAll(".channel.active").forEach(ch => ch.classList.remove("active")); el.classList.add("active"); playChannelInPreview(idx); };
        favButton.onclick = (e) => { e.stopPropagation(); toggleFavorite(c.name, favButton); };
        G_UI.channels.appendChild(el);
      });
    }

    // (playChannelInPreview, changeChannel, toggleFullscreen, playStream, stopStream fonksiyonları burada - Değişiklik yok)
    function playChannelInPreview(localIdx) {
        currentChannelIndex = localIdx; const channel = currentChannelList[localIdx]; if (!channel) return;
        
        G_UI.player.logo.style.visibility = 'visible'; 
        G_UI.player.controls.forEach(btn => btn.style.visibility = 'visible');
        G_UI.player.logo.src = channel.logo || ''; 
        G_UI.preview.placeholder.style.display = 'none';

        if (channel.youtubeId) {
            stopStream(G_UI.preview.video, hls);
            G_UI.preview.video.style.display = 'none';
            const ytElement = document.getElementById('youtubePlayer');
            if (ytElement) {
                ytElement.style.display = 'block';
            }
            playYouTubeStream(channel.youtubeId);
            
        } else if (channel.url) {
            stopYouTubeStream(); 
            G_UI.preview.video.style.display = 'block';
            playStream(G_UI.preview.video, channel.url, true).then(instance => hls = instance);
        }
    }
    function changeChannel(direction) {
        if (currentChannelList.length === 0 || currentChannelIndex < 0) return;
        const newIndex = (currentChannelIndex + direction + currentChannelList.length) % currentChannelList.length, channelElements = G_UI.channels.querySelectorAll('.channel');
        if (channelElements[newIndex]) { channelElements[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); channelElements[newIndex].querySelector('.channel-info').click(); }
    }
    function toggleFullscreen() {
        if (currentChannelIndex < 0) return;
        const channel = currentChannelList[currentChannelIndex];
        let playerElement;
        if (channel.youtubeId) {
            playerElement = document.getElementById('youtubePlayer');
        } else {
            playerElement = G_UI.preview.video;
        }
        if (!playerElement) {
            console.error("Tam ekran yapılacak oynatıcı elementi bulunamadı.");
            return;
        }
        if (!document.fullscreenElement) {
            if (playerElement.tagName === 'IFRAME') {
                playerElement.requestFullscreen().catch(err => alert(`Tam ekran modu hatası: ${err.message}`));
            } else {
                playerElement.requestFullscreen().catch(err => alert(`Tam ekran modu hatası: ${err.message}`));
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
    async function playStream(videoElement, url) {
        stopStream(videoElement, hls);
        if (Hls.isSupported()) { hls = new Hls(); hls.loadSource(url); hls.attachMedia(videoElement); } 
        else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) videoElement.src = url;
        else { alert("Bu tarayıcı video oynatmayı desteklemiyor."); return null; }
        videoElement.muted = false; videoElement.volume = 1.0;
        try { await videoElement.play(); } catch (err) { console.error("Otomatik oynatma engellendi:", err); }
        return hls;
    }
    function stopStream(videoElement, hlsInstance) {
        videoElement.pause(); videoElement.removeAttribute("src");
        try { videoElement.load(); } catch (e) {}
        if (hlsInstance) hlsInstance.destroy();
    }
    
    // ######################################################################
    // # --- GÜNCELLENEN BÖLÜM ---
    // # Sayfa yüklendiğinde artık 'channels.json' dosyasını çekiyoruz.
    // ######################################################################
    window.addEventListener("load", async () => {
      createThemeSelector(); 
      applyTheme(localStorage.getItem('iptvTheme') || 'default');
      
      try {
        // 1. channels.json dosyasını çek
        const response = await fetch('channels.json?v=' + new Date().getTime()); // Önbelleği atlamak için cache-busting
        if (!response.ok) {
            throw new Error(`HTTP hatası! Durum: ${response.status}`);
        }
        const channelData = await response.json();
        
        // 2. JSON'dan gelen 'channels' dizisini ana listemiz olarak ayarla
        baseChannelList = channelData.channels.filter(c => (c.url || c.youtubeId) && c.name);
        
        // 3. 'Tüm Kanallar' grubunu oluştur (eskisi gibi)
        const allChannelsGroup = JSON.parse(JSON.stringify(baseChannelList));
        allChannelsGroup.forEach(channel => { channel.group = 'Tüm Kanallar'; });
        allChannels = [...baseChannelList, ...allChannelsGroup];
        
        // 4. EPG verisini çek ve grupları/kanalları listele
        await fetchEPG();
        listGroups();
        
      } catch (error) {
        // Hata durumunda kullanıcıyı bilgilendir
        console.error('Kanal listesi (channels.json) yüklenemedi:', error);
        const errorMsg = '<p style="padding: 10px; color: var(--text-secondary); font-size: 1.1em;">Kanal listesi (channels.json) yüklenemedi. Lütfen dosyanın doğru yerde ve geçerli bir JSON formatında olduğundan emin olun.</p>';
        G_UI.channels.innerHTML = errorMsg;
        G_UI.preview.placeholder.innerHTML = `<h1>Hata</h1><p>channels.json dosyası yüklenemedi.</p>`;
      }
      
      // Tam ekran olayını oynatıcı alanına bağla (eskisi gibi)
      document.getElementById('previewArea').addEventListener('dblclick', toggleFullscreen);
    });
  </script>
</body>
</html>
