<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV Arayüz</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
        /* Boyutlar küçültüldü */
        --player-height: 55px;
        --category-bar-height: 40px;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; height: 100%; background: #000; font-family: sans-serif; overflow: hidden;
      color: white;
      font-size: 14px; /* Ana font boyutu küçültüldü */
    }
    #app {
      display: flex; flex-direction: column; height: 100%;
      padding-bottom: calc(var(--player-height) + var(--category-bar-height));
    }
    #main {
      display: flex; flex: 1; overflow: hidden;
    }
    #channels {
      flex: 0 0 260px; /* Kanal listesi genişliği azaltıldı */
      background: #121212;
      border-right: 2px solid #333;
      overflow-y: auto;
      padding: 8px; /* İç boşluk azaltıldı */
      display: flex; flex-direction: column; gap: 6px; /* Aralık azaltıldı */
    }
    #previewArea {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: #000;
    }
    #previewPlaceholder {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        gap: 15px;
        color: #555;
        height: 100%;
    }
    #previewPlaceholder h2 { font-size: 1.5em; }
    #previewPlaceholder p { font-size: 1em; }

    #previewVideo {
        width: 100%;
        height: 100%;
        background: #000;
        object-fit: contain;
        display: none;
    }
    
    /* Kategori Çubuğu */
    #groups {
        position: fixed;
        bottom: var(--player-height);
        left: 0;
        width: 100%;
        height: var(--category-bar-height);
        background: #101010;
        border-top: 1px solid #333;
        display: flex;
        overflow-x: auto;
        z-index: 1000;
        scrollbar-width: thin;
        scrollbar-color: #555 #101010;
    }
    #groups::-webkit-scrollbar { height: 6px; }
    #groups::-webkit-scrollbar-track { background: #101010; }
    #groups::-webkit-scrollbar-thumb { background-color: #555; border-radius: 10px; }

    .group {
      padding: 0 18px; /* Boşluk azaltıldı */
      cursor: pointer;
      background: transparent;
      border-right: 1px solid #333;
      line-height: var(--category-bar-height);
      white-space: nowrap;
      flex-shrink: 0;
      transition: background-color 0.2s;
    }
    .group:hover, .group.active {
      background: #3366cc;
    }

    .channel {
      display: flex; align-items: center; gap: 8px; /* Aralık azaltıldı */
      background: #1e1e1e;
      border-radius: 6px; /* Kenar yuvarlaklığı azaltıldı */
      padding: 8px; /* İç boşluk azaltıldı */
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    .channel:hover { background: #2c2c2c; }
    .channel.active { border-color: #3366cc; background: #252a3a; }
    .channel img { width: 38px; height: 38px; object-fit: contain; } /* Logo küçültüldü */
    .epg-title { color: turquoise; font-size: 0.9em; } /* Yazı boyutu ayarlandı */

    /* Sabit Oynatıcı (Kontrol Çubuğu) */
    #playerContainer {
      position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-height); background: #1a1a1a;
      display: none; z-index: 999; align-items: center; padding: 0 15px;
      border-top: 2px solid #333;
      justify-content: space-between;
    }
    .player-info { display: flex; align-items: center; gap: 12px; } /* Aralık azaltıldı */
    .player-info img { width: 40px; height: 40px; object-fit: contain; border-radius: 5px; background-color: #d8d8d8; } /* Logo küçültüldü */
    .player-text .title { font-size: 1em; font-weight: bold; } /* Yazı boyutu küçültüldü */
    .player-text .telegram { font-size: 0.85em; color: #aaa; } /* Yazı boyutu küçültüldü */
    .player-controls { display: flex; align-items: center; gap: 12px; } /* Aralık azaltıldı */
    .control-btn {
      background: #2a2a2a; color: white; border: none; font-size: 16px; /* İkon boyutu küçültüldü */
      border-radius: 50%; cursor: pointer;
      width: 36px; height: 36px; /* Buton boyutu küçültüldü */
      display: flex; align-items: center; justify-content: center;
    }
    .control-btn:hover { background: #3366cc; }

    /* Tam Ekran Oynatıcı */
    #fullscreenVideoContainer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black;
      display: none; z-index: 1001;
    }
    #fullscreenVideo { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="app">
    <div id="main">
      <div id="channels"></div>
      <div id="previewArea">
        <div id="previewPlaceholder">
          <h2>Kanal Önizleme</h2>
          <p>Lütfen bir kategori seçip kanala tıklayınız.</p>
        </div>
        <video id="previewVideo" controls autoplay playsinline></video>
      </div>
    </div>
  </div>

  <div id="groups"></div>

  <div id="playerContainer">
    <div class="player-info">
      <img id="playerLogo" src="" alt="logo">
      <div class="player-text">
        <div class="title">Car Video Pro</div>
        <div class="telegram">Telegram : t.me/car_video_pro</div>
      </div>
    </div>
    <div class="player-controls">
      <button class="control-btn" onclick="changeChannel(-1)">&#9664;</button>
      <button class="control-btn" onclick="changeChannel(1)">&#9654;</button>
      <button class="control-btn" onclick="toggleFullscreen()">&#x26F6;</button>
    </div>
  </div>

  <div id="fullscreenVideoContainer">
      <video id="fullscreenVideo" controls autoplay playsinline></video>
  </div>


  <script>
    const m3uUrl = "https://raw.githubusercontent.com/atakan1983/tvepic/refs/heads/main/mehmet_guncel.m3u";
    const epgUrl = "https://raw.githubusercontent.com/atakan1983/tvepic/refs/heads/main/kabloepg.xml";

    const G_UI = {
        groups: document.getElementById("groups"),
        channels: document.getElementById("channels"),
        preview: {
            placeholder: document.getElementById("previewPlaceholder"),
            video: document.getElementById("previewVideo")
        },
        player: {
            container: document.getElementById("playerContainer"),
            logo: document.getElementById("playerLogo")
        },
        fullscreen: {
            container: document.getElementById("fullscreenVideoContainer"),
            video: document.getElementById("fullscreenVideo")
        }
    };

    let allChannels = [], epgData = {}, currentChannelList = [], hls, hlsFs;
    let currentChannelIndex = -1;

    async function fetchM3U() {
      const res = await fetch(m3uUrl);
      const text = await res.text();
      const lines = text.split(/\r?\n/);
      let current = null;
      for (const line of lines) {
        if (line.startsWith("#EXTINF")) {
          const name = line.match(/,(.*)$/)?.[1].trim();
          const logo = line.match(/tvg-logo="(.*?)"/)?.[1];
          const group = line.match(/group-title="(.*?)"/)?.[1];
          const id = line.match(/tvg-id="(.*?)"/)?.[1];
          current = { name, logo, group: group || "Diğer", epgId: id };
        } else if (current && line.startsWith("http")) {
          current.url = line.trim();
          allChannels.push(current);
          current = null;
        }
      }
    }
    async function fetchEPG() {
      try {
        const res = await fetch(epgUrl);
        const xml = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        const progs = doc.querySelectorAll("programme");
        const now = new Date();
        for (const p of progs) {
          const chan = p.getAttribute("channel");
          const start = parseEPGDate(p.getAttribute("start"));
          const stop = parseEPGDate(p.getAttribute("stop"));
          if (now >= start && now <= stop) {
            epgData[chan] = p.querySelector("title")?.textContent || "";
          }
        }
      } catch (error) {
        console.error("EPG verisi alınamadı:", error);
      }
    }
    function parseEPGDate(str) {
      if (!str) return new Date(0);
      const datePart = str.slice(0, 14);
      const tzPart = str.slice(15, 20);
      const y = +datePart.slice(0, 4), m = +datePart.slice(4, 6) - 1, d = +datePart.slice(6, 8);
      const h = +datePart.slice(8, 10), min = +datePart.slice(10, 12);
      const tzSign = tzPart[0] === '+' ? 1 : -1;
      const tzHours = +tzPart.slice(1, 3), tzMins = +tzPart.slice(3, 5);
      const offset = tzSign * (tzHours * 60 + tzMins) * 60000;
      const utcDate = new Date(Date.UTC(y, m, d, h, min));
      return new Date(utcDate.getTime() - offset);
    }

    function listGroups() {
      const groups = [...new Set(allChannels.map(c => c.group))].sort();
      G_UI.groups.innerHTML = "";
      groups.forEach((g) => {
        const el = document.createElement("div");
        el.className = "group";
        el.textContent = g;
        el.onclick = () => {
          document.querySelectorAll(".group").forEach(e => e.classList.remove("active"));
          el.classList.add("active");
          listChannels(g);
        };
        G_UI.groups.appendChild(el);
      });
      if (G_UI.groups.firstChild) G_UI.groups.firstChild.click();
    }

    function listChannels(group) {
      G_UI.channels.innerHTML = "";
      stopStream(G_UI.preview.video, hls);
      hls = null;
      G_UI.preview.video.style.display = 'none';
      G_UI.preview.placeholder.style.display = 'flex';

      currentChannelList = allChannels.filter(c => c.group === group);
      currentChannelList.forEach((c, idx) => {
        const epgTitle = epgData[c.epgId] || "";
        const el = document.createElement("div");
        el.className = "channel";
        el.innerHTML = `<img src="${c.logo || ''}" onerror="this.style.display='none'" alt="logo">
        <div><div>${c.name}</div><div class="epg-title">${epgTitle}</div></div>`;
        el.onclick = () => {
            document.querySelectorAll(".channel.active").forEach(ch => ch.classList.remove("active"));
            el.classList.add("active");
            playChannelInPreview(idx);
        };
        G_UI.channels.appendChild(el);
      });
    }

    function playChannelInPreview(idx) {
        currentChannelIndex = idx;
        const channel = currentChannelList[idx];
        if (!channel) return;

        G_UI.player.container.style.display = "flex";
        G_UI.player.logo.src = channel.logo || '';

        G_UI.preview.placeholder.style.display = 'none';
        G_UI.preview.video.style.display = 'block';

        playStream(G_UI.preview.video, channel.url, true).then(instance => hls = instance);
    }

    function changeChannel(direction) {
        if (currentChannelList.length === 0 || currentChannelIndex < 0) return;
        const newIndex = (currentChannelIndex + direction + currentChannelList.length) % currentChannelList.length;
        const channelElements = G_UI.channels.querySelectorAll('.channel');
        if(channelElements[newIndex]) {
            channelElements[newIndex].click();
        }
    }

    function toggleFullscreen() {
        if (currentChannelIndex < 0) return;

        const isFs = G_UI.fullscreen.container.style.display === 'block';
        if (isFs) {
            G_UI.fullscreen.container.style.display = 'none';
            stopStream(G_UI.fullscreen.video, hlsFs);
            if(document.fullscreenElement) document.exitFullscreen();
        } else {
            const channel = currentChannelList[currentChannelIndex];
            if (!channel) return;
            G_UI.fullscreen.container.style.display = 'block';
            playStream(G_UI.fullscreen.video, channel.url, true).then(instance => hlsFs = instance);
            if (G_UI.fullscreen.container.requestFullscreen) {
                G_UI.fullscreen.container.requestFullscreen().catch(err => console.log(err));
            }
        }
    }
    
    async function playStream(videoElement, url, isUnmuted) {
        let hlsInstance = (videoElement.id === 'previewVideo') ? hls : hlsFs;
        stopStream(videoElement, hlsInstance);
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && videoElement.canPlayType('application/vnd.apple.mpegurl')) {
            videoElement.src = url;
        } else if (Hls.isSupported()) {
            hlsInstance = new Hls();
            hlsInstance.loadSource(url);
            hlsInstance.attachMedia(videoElement);
        } else {
            alert("Bu tarayıcı video oynatmayı desteklemiyor.");
            return null;
        }
        
        videoElement.muted = !isUnmuted;
        try {
            await videoElement.play();
        } catch (err) {
            console.error("Video oynatma hatası (tarayıcı engellemiş olabilir):", err);
            videoElement.muted = true;
            videoElement.play();
        }
        return hlsInstance;
    }

    function stopStream(videoElement, hlsInstance) {
        videoElement.pause();
        videoElement.removeAttribute("src");
        try { videoElement.load(); } catch (e) {}
        if (hlsInstance) {
            hlsInstance.destroy();
        }
    }
    
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        if (G_UI.fullscreen.container.style.display === "block") {
           toggleFullscreen();
        }
      }
    });

    window.addEventListener("load", async () => {
      await fetchM3U();
      await fetchEPG();
      listGroups();
    });
  </script>
</body>
</html>
