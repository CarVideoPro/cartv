<!DOCTYPE html>
<html lang="tr">
<head>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Video Pro TV</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  
  <style>
    :root {
        --player-height: 65px; 
        --category-bar-height: 50px; 
        --video-controls-height: 70px;
    }

    /* --- TEMALAR --- */
    [data-theme='default'] { --bg-primary: #000000; --bg-secondary: #181818; --bg-tertiary: #252525; --bg-hover: #3a3a3a; --border-color: #444; --accent-color: #3366cc; --accent-color-darker: #254a9e; --text-primary: #ffffff; --text-secondary: #bbbbbb; --epg-color: #4dd0e1; --favorite-color: #ffd700; }
    [data-theme='forest'] { --bg-primary: #0d1b12; --bg-secondary: #162b1f; --bg-tertiary: #20382b; --bg-hover: #2d4d3b; --border-color: #444; --accent-color: #4CAF50; --accent-color-darker: #2e7d32; --text-primary: #e8f5e9; --text-secondary: #a5d6a7; --epg-color: #81c784; --favorite-color: #ffeb3b; }
    [data-theme='royal'] { --bg-primary: #120a1f; --bg-secondary: #1e1233; --bg-tertiary: #2d1b4e; --bg-hover: #40276b; --border-color: #4a477a; --accent-color: #ab47bc; --accent-color-darker: #7b1fa2; --text-primary: #f3e5f5; --text-secondary: #e1bee7; --epg-color: #ce93d8; --favorite-color: #fdd835; }
    [data-theme='sunset'] { --bg-primary: #1f120a; --bg-secondary: #331d10; --bg-tertiary: #4a2b18; --bg-hover: #633a20; --border-color: #5d4037; --accent-color: #ff5722; --accent-color-darker: #d84315; --text-primary: #fbe9e7; --text-secondary: #ffccbc; --epg-color: #ffab91; --favorite-color: #ffc107; }
    [data-theme='steel'] { --bg-primary: #121212; --bg-secondary: #1e1e1e; --bg-tertiary: #2c2c2c; --bg-hover: #424242; --border-color: #616161; --accent-color: #90a4ae; --accent-color-darker: #546e7a; --text-primary: #eceff1; --text-secondary: #b0bec5; --epg-color: #cfd8dc; --favorite-color: #ffffff; }
    [data-theme='ocean'] { --bg-primary: #01121e; --bg-secondary: #022035; --bg-tertiary: #033152; --bg-hover: #054875; --border-color: #065a8f; --accent-color: #00b0ff; --accent-color-darker: #0081cb; --text-primary: #e1f5fe; --text-secondary: #81d4fa; --epg-color: #4fc3f7; --favorite-color: #ffeb3b; }
    [data-theme='magma'] { --bg-primary: #1a0505; --bg-secondary: #2b0b0b; --bg-tertiary: #421212; --bg-hover: #5e1b1b; --border-color: #7f2a2a; --accent-color: #ff5252; --accent-color-darker: #c62828; --text-primary: #ffebee; --text-secondary: #ffcdd2; --epg-color: #ef5350; --favorite-color: #ffff00; }
    [data-theme='lavender'] { --bg-primary: #15121c; --bg-secondary: #231e2e; --bg-tertiary: #322b42; --bg-hover: #453b59; --border-color: #574b6e; --accent-color: #b39ddb; --accent-color-darker: #7e57c2; --text-primary: #ede7f6; --text-secondary: #d1c4e9; --epg-color: #9575cd; --favorite-color: #ffd700; }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; height: 100%; background: var(--bg-primary); font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
      color: var(--text-primary);
      font-size: 15px;
      transition: transform 0.2s ease;
      transform-origin: top left;
    }
    #app {
      display: flex; flex-direction: column; height: 100%;
      padding-bottom: calc(var(--player-height) + var(--category-bar-height));
    }
    #main { display: flex; flex: 1; overflow: hidden; }
    
    /* --- KANAL Lƒ∞STESƒ∞ --- */
    #channels {
      flex: 0 0 300px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      padding: 12px;
      display: flex; flex-direction: column; gap: 10px;
      z-index: 50;
    }

    .channel {
      display: flex; align-items: center; gap: 15px;
      background: var(--bg-tertiary);
      border-radius: 8px; 
      padding: 12px 15px;
      border: none;
      border-left: 5px solid transparent;
      transition: background-color 0.2s, transform 0.1s;
    }
    .channel:hover { background: var(--bg-hover); transform: translateX(2px); }
    .channel.active { background: var(--bg-hover); border-left-color: var(--accent-color); }
    .channel.playing-active { background: var(--accent-color-darker); border-left-color: #fff; }
    
    .channel img { width: 45px; height: 45px; object-fit: contain; flex-shrink: 0; }
    .channel-info { flex-grow: 1; cursor: pointer; display: flex; align-items: center; gap: 10px; min-width: 0; }
    .channel-info > div { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
    
    .channel-name-text { font-weight: 600; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
    .channel-stop-text { display: none; color: #fff; font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px; }
    
    .channel.playing-active .channel-name-text { display: none; }
    .channel.playing-active .channel-stop-text { display: flex; align-items: center; gap: 5px; }
    .channel.playing-active .epg-title { display: none; } 

    .epg-title { color: var(--epg-color); font-size: 0.9em; margin-top: 4px; opacity: 0.9; }
    .fav-btn { font-size: 24px; cursor: pointer; padding: 5px; color: var(--text-secondary); transition: 0.2s; }
    .fav-btn:hover { transform: scale(1.2); color: var(--favorite-color); }
    .fav-btn.favorited { color: var(--favorite-color); }
    .youtube-icon { width: 22px; height: 22px; flex-shrink: 0; margin-left: 5px; }

    /* --- Vƒ∞DEO ALANI --- */
    #previewArea { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        background: var(--bg-primary); 
        position: relative; 
        overflow: hidden; 
    }
    
    #videoContainer { 
        flex: 1; 
        position: relative; 
        background: #000; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        width: 100%; 
        height: 100%; 
        overflow: hidden;
        z-index: 10;
    }
    
    #previewVideo, #youtubePlayer { width: 100%; height: 100%; object-fit: contain; }
    #youtubePlayer { display: none; }
    
    #previewPlaceholder {
        padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 20px; color: #777;
        width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 10; background: var(--bg-primary);
    }
    #previewPlaceholder h1 { font-size: 2.2em; color: var(--text-primary); margin-bottom: 10px; }
    #previewPlaceholder p { font-size: 1.1em; }

    /* --- SABƒ∞T KONTROL BARI --- */
    #videoControlsBar {
        height: var(--video-controls-height);
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 30px;
        padding: 0 15px; 
        flex-shrink: 0; 
        z-index: 20; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
    }

    .player-nav-btn {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        display: flex; align-items: center; gap: 10px;
        transition: all 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .player-nav-btn:hover {
        background: var(--accent-color);
        color: #fff;
        border-color: var(--accent-color);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .player-nav-btn:active { transform: translateY(1px); }
    
    #fullscreenBtn { background: var(--bg-hover); border-color: var(--accent-color); color: var(--accent-color); }
    #fullscreenBtn:hover { background: var(--accent-color); color: #fff; }

    /* --- KATEGORƒ∞LER --- */
    #groups {
        position: fixed; bottom: var(--player-height); left: 0; width: 100%; height: var(--category-bar-height);
        background: var(--bg-secondary); border-top: 1px solid var(--border-color);
        display: flex; overflow-x: auto; z-index: 1000;
        scrollbar-width: thin; scrollbar-color: var(--accent-color) var(--bg-secondary);
    }
    .group {
        padding: 0 25px; cursor: pointer; background: transparent;
        border-right: 1px solid var(--border-color);
        line-height: var(--category-bar-height); white-space: nowrap; flex-shrink: 0;
        transition: 0.2s; font-weight: 600; font-size: 15px; color: var(--text-secondary);
    }
    .group:hover { background: var(--bg-hover); color: var(--text-primary); }
    .group.active { background: var(--accent-color); color: #fff; }

    /* --- FOOTER --- */
    #playerContainer {
      position: fixed; bottom: 0; left: 0; width: 100%; height: var(--player-height); background: var(--bg-secondary);
      display: flex; z-index: 999; align-items: center;
      border-top: 1px solid rgba(255,255,255,0.1);
      justify-content: space-between; padding-right: 15px;
    }

    .marquee-container {
        flex-grow: 1; 
        overflow: hidden; 
        position: relative; 
        height: 100%;
        display: flex; align-items: center;
        margin-right: 15px;
        background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3)); 
        border-top: 2px solid var(--accent-color); 
        border-bottom: 2px solid var(--accent-color);
    }
    
    .marquee-text {
        position: absolute;
        white-space: nowrap;
        will-change: transform;
        animation: marquee 25s linear infinite;
        font-size: 1.5em;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 
            0 1px 2px rgba(0,0,0,0.8), 
            0 0 6px var(--accent-color); 
    }
    
    @keyframes marquee {
        from { left: 100%; transform: translateX(0); }
        to { left: 0; transform: translateX(-100%); }
    }

    .footer-controls { display: flex; align-items: center; gap: 15px; }
    .zoom-controls { display: flex; align-items: center; gap: 10px; background: var(--bg-primary); padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border-color); }
    .zoom-btn {
        background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
        width: 32px; height: 32px; border-radius: 4px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 18px;
    }
    .zoom-btn:hover { background: var(--accent-color); border-color: var(--accent-color); color: #fff; }
    
    #themeSelector { display: flex; align-items: center; gap: 8px; padding-left: 10px; border-left: 1px solid var(--border-color); }
    .theme-swatch {
        width: 22px; height: 22px; border-radius: 50%; cursor: pointer;
        border: 2px solid var(--border-color); transition: 0.2s;
    }
    .theme-swatch:hover { transform: scale(1.2); border-color: #fff; }
    .theme-swatch.active { border-color: #fff; box-shadow: 0 0 0 2px var(--accent-color); transform: scale(1.1); }

    @media (max-width: 600px) {
        #channels { flex: 0 0 220px; }
        .player-nav-btn { padding: 10px 15px; font-size: 13px; }
        .marquee-text { font-size: 1.2em; }
    }
  </style>
</head>
<body data-theme="default">
  <div id="app">
    <div id="main">
      <div id="channels"></div>
      
      <div id="previewArea">
        <div id="videoContainer">
            <div id="previewPlaceholder">
              <h1> üì∫ Car Video Pro TV üì∫</h1>
              <h2> üìû ƒ∞leti≈üim : Telegram : t.me/car_video_pro üìû</h2>
              <p>‚úîÔ∏è L√ºtfen bir kategori se√ßip kanala tƒ±klayƒ±nƒ±z. ‚úîÔ∏è</p>
            </div>
            <video id="previewVideo" autoplay playsinline style="display:none;"></video>
            <div id="youtubePlayer"></div>
        </div>

        <div id="videoControlsBar">
            <button class="player-nav-btn" onclick="changeChannel(-1)">
                <span>‚èÆ</span> Geri
            </button>
            
            <button class="player-nav-btn" id="fullscreenBtn" onclick="toggleFullscreen()">
                <span>‚õ∂</span> Tam Ekran
            </button>
            
            <button class="player-nav-btn" onclick="changeChannel(1)">
                ƒ∞leri <span>‚è≠</span>
            </button>
        </div>
      </div>
    </div>
  </div>

  <div id="groups"></div>

  <div id="playerContainer">
    <div class="marquee-container">
        <div class="marquee-text">Car Video Pro - Eƒülencenin Adresi -  üìû Telegram: t.me/car_video_pro üìû</div>
    </div>

    <div class="footer-controls">
        <div class="zoom-controls">
            <span style="font-size:18px">üîç</span>
            <button class="zoom-btn" onclick="updateZoom(-0.1)">-</button>
            <button class="zoom-btn" onclick="updateZoom(0.1)">+</button>
        </div>
        <div id="themeSelector"></div> 
    </div>
  </div>

  <script>
    const epgUrl = "https://raw.githubusercontent.com/ghokun/tv/main/bin/guide.xml";
    
    const G_UI = {
        groups: document.getElementById("groups"),
        channels: document.getElementById("channels"),
        preview: {
            placeholder: document.getElementById("previewPlaceholder"),
            video: document.getElementById("previewVideo"),
            youtube: document.getElementById("youtubePlayer")
        },
        themeSelector: document.getElementById("themeSelector")
    };
    
    const themes = {
        'default': { name: 'Varsayƒ±lan', color: '#3366cc' },
        'forest': { name: 'Orman', color: '#4CAF50' },
        'royal': { name: 'Kraliyet', color: '#9C27B0' },
        'sunset': { name: 'G√ºn Batƒ±mƒ±', color: '#FF5722' },
        'steel': { name: '√áelik', color: '#757575' },
        'ocean': { name: 'Okyanus', color: '#0074D9' },
        'magma': { name: 'Volkan', color: '#ff4136' },
        'lavender': { name: 'Lavanta', color: '#b19cd9' }
    };

    const YOUTUBE_ICON_SVG = `<svg class="youtube-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#FF0000" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>`;
    
    let allChannels = [], epgData = {}, currentChannelList = [], hls, baseChannelList = [];
    let currentChannelIndex = -1, activeGroupName = '';
    let ytPlayer;
    let isYouTubeApiReady = false;
    let isPlaying = false; 
    
    // *** YENƒ∞ EKLENDƒ∞: OYNATILAN KANALI OBJEY OLARAK TUTMA ***
    let currentlyPlayingChannel = null; // Sadece index deƒüil, kanalƒ±n kendisini tutar
    
    // --- ZOOM KAYIT Sƒ∞STEMƒ∞ ---
    const ZOOM_KEY = 'carVideoProZoom'; 
    let currentZoom = 1.0;

    function loadSavedZoom() {
        const saved = localStorage.getItem(ZOOM_KEY);
        if (saved) {
            currentZoom = parseFloat(saved);
            if (currentZoom < 0.5) currentZoom = 0.5;
            if (currentZoom > 1.5) currentZoom = 1.5;
            document.documentElement.style.zoom = currentZoom;
        }
    }

    function updateZoom(change) {
        currentZoom += change;
        if(currentZoom < 0.5) currentZoom = 0.5;
        if(currentZoom > 1.5) currentZoom = 1.5;
        document.documentElement.style.zoom = currentZoom;
        localStorage.setItem(ZOOM_KEY, currentZoom);
    }

    function onYouTubeIframeAPIReady() { isYouTubeApiReady = true; }

    function playYouTubeStream(videoId) {
        if (!isYouTubeApiReady) return;
        if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
             ytPlayer.loadVideoById({ videoId: videoId });
        } else {
            if (ytPlayer && typeof ytPlayer.destroy === 'function') ytPlayer.destroy();
            ytPlayer = new YT.Player('youtubePlayer', { 
                height: '100%', width: '100%', videoId: videoId,
                playerVars: { 'playsinline': 1, 'autoplay': 1, 'mute': 0, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
                events: { 'onReady': (event) => { event.target.playVideo(); isPlaying = true; updateActiveChannelVisuals(); } }
            });
        }
        isPlaying = true;
        updateActiveChannelVisuals();
    }

    function stopYouTubeStream() {
        if (ytPlayer && typeof ytPlayer.stopVideo === 'function') ytPlayer.stopVideo();
        const ytElement = document.getElementById('youtubePlayer');
        if (ytElement) ytElement.style.display = 'none';
    }

    function stopAllPlayback() {
        stopYouTubeStream();
        stopStream(G_UI.preview.video, hls);
        G_UI.preview.video.style.display = 'none';
        G_UI.preview.placeholder.style.display = 'flex';
        isPlaying = false;
        currentlyPlayingChannel = null; // √áalan kanalƒ± sƒ±fƒ±rla
        updateActiveChannelVisuals(); 
    }

    function getFavorites() { const favs = localStorage.getItem('iptvFavorites'); return favs ? JSON.parse(favs) : []; }
    function saveFavorites(favs) { localStorage.setItem('iptvFavorites', JSON.stringify(favs)); }
    
    function toggleFavorite(channelName, favButton) {
        let favorites = getFavorites();
        const index = favorites.indexOf(channelName);
        const wasEmpty = favorites.length === 0;
        const wasOnFavoritesTab = (activeGroupName === 'Favorilerim');

        if (index > -1) { favorites.splice(index, 1); favButton.classList.remove('favorited'); } 
        else { favorites.push(channelName); favButton.classList.add('favorited'); }
        
        saveFavorites(favorites);
        const isEmptyNow = favorites.length === 0;
        if (wasEmpty !== isEmptyNow) listGroups();
        if (wasOnFavoritesTab && !isEmptyNow) listChannels('Favorilerim');
    }

    function applyTheme(themeName) {
        document.body.dataset.theme = themeName;
        localStorage.setItem('iptvTheme', themeName);
        document.querySelectorAll('.theme-swatch').forEach(swatch => swatch.classList.toggle('active', swatch.dataset.theme === themeName));
    }
    function createThemeSelector() {
        G_UI.themeSelector.innerHTML = "";
        for (const [key, theme] of Object.entries(themes)) {
            const swatch = document.createElement('div');
            swatch.className = 'theme-swatch'; swatch.dataset.theme = key; swatch.title = theme.name;
            swatch.style.backgroundColor = theme.color; swatch.onclick = () => applyTheme(key);
            G_UI.themeSelector.appendChild(swatch);
        }
    }
    function showConnectionWarning(isConnected) {
        const warningId = 'connection-warning-banner'; let warningEl = document.getElementById(warningId);
        if (isConnected) { if (warningEl) warningEl.remove(); } 
        else if (!warningEl) {
            warningEl = document.createElement('div'); warningEl.id = warningId;
            warningEl.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; background-color: #f44336; color: white; text-align: center; padding: 10px 0; font-weight: bold; z-index: 10000;`;
            warningEl.textContent = 'UYARI: ƒ∞nternet baƒülantƒ±sƒ± yok! Kanallar y√ºklenemeyebilir veya mevcut yayƒ±n durabilir.';
            document.body.prepend(warningEl);
        }
    }
    
    window.addEventListener('online', () => showConnectionWarning(true));
    window.addEventListener('offline', () => showConnectionWarning(false));
    
    async function fetchEPG() {
      try {
        const res = await fetch(epgUrl); if (!res.ok) throw new Error(); showConnectionWarning(true);
        const xml = await res.text(), parser = new DOMParser(), doc = parser.parseFromString(xml, "text/xml"), progs = doc.querySelectorAll("programme"), now = new Date();
        for (const p of progs) {
          const chan = p.getAttribute("channel"), start = parseEPGDate(p.getAttribute("start")), stop = parseEPGDate(p.getAttribute("stop"));
          if (now >= start && now <= stop) epgData[chan] = p.querySelector("title")?.textContent || "";
        }
      } catch (error) { console.error("EPG Hata"); showConnectionWarning(false); }
    }
    function parseEPGDate(str) {
      if (!str) return new Date(0);
      const dp = str.slice(0, 14), tz = str.slice(15, 20), y = +dp.slice(0, 4), m = +dp.slice(4, 6) - 1, d = +dp.slice(6, 8), h = +dp.slice(8, 10), min = +dp.slice(10, 12);
      const s = tz[0] === '+' ? 1 : -1, th = +tz.slice(1, 3), tm = +tz.slice(3, 5), offset = s * (th * 60 + tm) * 60000;
      return new Date(new Date(Date.UTC(y, m, d, h, min)).getTime() - offset);
    }

    function listGroups() {
      const currentActiveGroup = document.querySelector('.group.active')?.textContent || 'Favorilerim';
      const desiredOrder = ['Favorilerim', 'T√ºm Kanallar', 'Ulusal', 'Spor', '√áocuk & Eƒüitim', 'Belgesel', 'M√ºzik', 'YouTube', 'M√ºzik Ekstra', 'Ya≈üam & EƒüLence', 'Sinema ve Dizi', 'Ulusal Haber'];
      let groups = [...new Set(allChannels.map(c => c.group))].filter(g => g && g !== 'Bilgilendirme'); 
      groups.unshift('Favorilerim'); groups = [...new Set(groups)];
      groups.sort((a, b) => { const iA = desiredOrder.indexOf(a), iB = desiredOrder.indexOf(b); if (iA !== -1 && iB !== -1) return iA - iB; if (iA !== -1) return -1; if (iB !== -1) return 1; return a.localeCompare(b); });
      G_UI.groups.innerHTML = ""; let groupToActivate = null;
      
      groups.forEach((g) => {
        if (g === 'Favorilerim' && getFavorites().length === 0) return;
        const el = document.createElement("div"); el.className = "group"; el.textContent = g;
        el.onclick = () => { document.querySelectorAll(".group.active").forEach(e => e.classList.remove("active")); el.classList.add("active"); activeGroupName = g; listChannels(g); };
        G_UI.groups.appendChild(el); if (g === currentActiveGroup) groupToActivate = el;
      });
      if (groupToActivate) groupToActivate.click(); else if (G_UI.groups.firstChild) G_UI.groups.firstChild.click();
    }

    function listChannels(group) {
      G_UI.channels.innerHTML = "";
      const favorites = getFavorites();
      if (group === 'Favorilerim') currentChannelList = baseChannelList.filter(c => favorites.includes(c.name));
      else currentChannelList = allChannels.filter(c => c.group === group);
      
      currentChannelList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      
      currentChannelList.forEach((c, idx) => {
        const epgTitle = epgData[c.epgId] || "", isFavorited = favorites.includes(c.name);
        const el = document.createElement("div"); el.className = "channel";
        
        el.innerHTML = `
            <div class="channel-info">
                <img src="${c.logo || ''}" onerror="this.style.display='none'" alt="logo">
                <div>
                    <div class="channel-name-text">${c.name}</div>
                    <div class="channel-stop-text"><span>‚èπ</span>DURDUR</div>
                    <div class="epg-title">${epgTitle}</div>
                </div>
            </div>
            ${c.youtubeId ? YOUTUBE_ICON_SVG : ''}
            <span class="fav-btn ${isFavorited ? 'favorited' : ''}">‚òÖ</span>
        `;
        
        el.querySelector('.channel-info').onclick = () => { 
            // Tƒ±klama kontrol√º artƒ±k OBJE √ºzerinden (isime g√∂re) yapƒ±lƒ±yor
            const isCurrentlyPlayingThis = isPlaying && currentlyPlayingChannel && currentlyPlayingChannel.name === c.name;
            
            if (isCurrentlyPlayingThis) {
                stopAllPlayback();
            } else {
                document.querySelectorAll(".channel.active").forEach(ch => ch.classList.remove("active")); 
                el.classList.add("active"); 
                playChannelInPreview(idx); 
            }
        };
        
        el.querySelector('.fav-btn').onclick = (e) => { e.stopPropagation(); toggleFavorite(c.name, el.querySelector('.fav-btn')); };
        G_UI.channels.appendChild(el);
      });
      updateActiveChannelVisuals(); 
    }

    // *** D√úZELTƒ∞LDƒ∞: Sadece sƒ±ra numarasƒ±na deƒüil, kanal ismine bakƒ±yoruz ***
    function updateActiveChannelVisuals() {
        const channelElements = document.querySelectorAll('#channels .channel');
        
        channelElements.forEach((el, idx) => {
            const channelData = currentChannelList[idx];
            // ≈ûuan √ßalan kanal, listedeki bu kanala e≈üit mi?
            const isThisChannelPlaying = isPlaying && currentlyPlayingChannel && (currentlyPlayingChannel.name === channelData.name);

            if (isThisChannelPlaying) {
                el.classList.add('playing-active');
                el.classList.add('active');
            } else {
                el.classList.remove('playing-active');
                // Se√ßili kalma durumunu korumak i√ßin 'active' sƒ±nƒ±fƒ±nƒ± hemen silmiyoruz, 
                // sadece oynatma g√∂rselini kaldƒ±rƒ±yoruz.
                // ƒ∞steƒüe baƒülƒ±: Oynatƒ±lmƒ±yorsa 'active' silinebilir ama kullanƒ±cƒ± son se√ßtiƒüini g√∂rmek isteyebilir.
                // Biz burada sadece 'playing-active' ile oynuyoruz.
                if (!isThisChannelPlaying) {
                   // Eƒüer bu kanal √ßalmƒ±yorsa ve oynatma devam ediyorsa (ba≈üka kanal √ßalƒ±yorsa), bunun active'ini sil.
                   if(isPlaying) el.classList.remove('active');
                }
            }
        });
    }

    function playChannelInPreview(localIdx) {
        const channel = currentChannelList[localIdx]; if (!channel) return;
        currentChannelIndex = localIdx; 
        currentlyPlayingChannel = channel; // *** √áALAN KANALI KAYDET ***
        
        G_UI.preview.placeholder.style.display = 'none';
        isPlaying = true; 

        if (channel.youtubeId) {
            stopStream(G_UI.preview.video, hls);
            G_UI.preview.video.style.display = 'none';
            const ytElement = document.getElementById('youtubePlayer');
            if (ytElement) ytElement.style.display = 'block';
            playYouTubeStream(channel.youtubeId);
        } else if (channel.url) {
            stopYouTubeStream(); 
            G_UI.preview.video.style.display = 'block';
            playStream(G_UI.preview.video, channel.url, true).then(instance => {
                hls = instance;
                updateActiveChannelVisuals(); 
            });
        }
        updateActiveChannelVisuals();
    }

    function changeChannel(direction) {
        if (currentChannelList.length === 0) return;
        
        // Eƒüer ≈üu an √ßalan bir kanal varsa, onun listedeki indeksini bul
        // (√á√ºnk√º kategori deƒüi≈ümi≈ü olabilir, currentChannelIndex eski listede kalmƒ±≈ü olabilir)
        let baseIndex = -1;
        if (currentlyPlayingChannel) {
            baseIndex = currentChannelList.findIndex(c => c.name === currentlyPlayingChannel.name);
        }
        
        // Eƒüer listede yoksa veya √ßalan yoksa ba≈ütan ba≈üla
        if (baseIndex === -1) baseIndex = 0;

        const newIndex = (baseIndex + direction + currentChannelList.length) % currentChannelList.length;
        const channelElements = G_UI.channels.querySelectorAll('.channel');
        
        if (channelElements[newIndex]) { 
            channelElements[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); 
            channelElements[newIndex].querySelector('.channel-info').click(); 
        }
    }

    function toggleFullscreen() {
        if (!currentlyPlayingChannel) return; // √áalan yoksa yapma
        
        let playerElement;
        if (currentlyPlayingChannel.youtubeId) {
             playerElement = document.getElementById('youtubePlayer'); 
        } else {
            playerElement = G_UI.preview.video;
        }

        if (!playerElement) return;

        if (!document.fullscreenElement) {
            if (playerElement.requestFullscreen) playerElement.requestFullscreen().catch(e => console.log(e));
            else if (playerElement.webkitRequestFullscreen) playerElement.webkitRequestFullscreen();
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
    }

    async function playStream(videoElement, url) {
        stopStream(videoElement, hls);
        if (Hls.isSupported()) { hls = new Hls(); hls.loadSource(url); hls.attachMedia(videoElement); } 
        else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) videoElement.src = url;
        videoElement.muted = false; videoElement.volume = 1.0;
        try { await videoElement.play(); } catch (err) { console.error(err); }
        return hls;
    }
    function stopStream(videoElement, hlsInstance) {
        videoElement.pause(); videoElement.removeAttribute("src");
        try { videoElement.load(); } catch (e) {}
        if (hlsInstance) hlsInstance.destroy();
    }
    
    window.addEventListener("load", async () => {
      createThemeSelector(); 
      applyTheme(localStorage.getItem('iptvTheme') || 'default');
      loadSavedZoom(); // Kayƒ±tlƒ± zoom ayarƒ±nƒ± y√ºkle
      
      try {
        const response = await fetch('channels.json?v=' + new Date().getTime());
        if (!response.ok) throw new Error();
        const channelData = await response.json();
        baseChannelList = channelData.channels.filter(c => (c.url || c.youtubeId) && c.name);
        const allChannelsGroup = JSON.parse(JSON.stringify(baseChannelList));
        allChannelsGroup.forEach(channel => { channel.group = 'T√ºm Kanallar'; });
        allChannels = [...baseChannelList, ...allChannelsGroup];
        await fetchEPG();
        listGroups();
      } catch (error) {
        console.error('Kanal listesi y√ºklenemedi:', error);
        G_UI.channels.innerHTML = '<p style="padding:10px;color:#aaa;">Kanal listesi (channels.json) y√ºklenemedi.</p>';
      }
      
      document.getElementById('previewArea').addEventListener('dblclick', toggleFullscreen);
    });
  </script>
</body>
</html>